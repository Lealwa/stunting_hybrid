<!DOCTYPE html>
<html>
<head>
    <title>Peta Stunting Madura</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="map"></div>

    <div id="forecast-container" class="hidden">
        <div class="forecast-header">
            <div class="forecast-title">
                <h3 id="region-title">Tren Prevalensi Stunting</h3>
                <div id="current-prevalence"></div>
            </div>
            <div class="forecast-controls">
                <select id="forecast-region-selector">
                    <option value="all_regions">Semua Kecamatan</option>
                    <!-- Options will be populated dynamically -->
                </select>
                <button id="toggle-forecast-btn" onclick="toggleForecastContainer()">Sembunyikan</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="forecast-chart"></canvas>
        </div>
        <div id="factors-container" class="hidden">
            <div class="factors-content">
                <ul id="factors-list"></ul>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Inisialisasi peta
        var map = L.map('map').setView([-7.0, 113.3], 9); // Koordinat Madura

        // Tambahkan layer base map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Default warna
        var defaultColor = '#c8cfdb';
        var stuntingData = {};  // Data akan diisi dari API
        var availableYears = []; // Tahun yang tersedia
        var currentYear = null; // Tahun yang dipilih saat ini
        var currentRegionProps = null;

        // Buat year selector control
        var yearControl = L.control({position: 'topleft'});
        
        yearControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'year-control');
            div.innerHTML = '<label>Tahun:</label><select id="year-selector"></select>';
            return div;
        };
        
        yearControl.addTo(map);
        
        // Mencegah klik pada kontrol mempengaruhi peta
        setTimeout(function() {
            L.DomEvent.disableClickPropagation(document.querySelector('.year-control'));
        }, 100);
        
        // Fungsi untuk memuat daftar tahun yang tersedia
        function loadAvailableYears() {
            fetch('/api/available-years')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error("Error loading years:", data.error);
                        // Fallback ke data default jika gagal
                        availableYears = ["2020", "2021", "2022", "2023", "2024"];
                    } else {
                        availableYears = data.years;
                    }
                    
                    // Populasi year selector
                    const selector = document.getElementById('year-selector');
                    selector.innerHTML = ''; // Hapus opsi yang ada
                    
                    availableYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        selector.appendChild(option);
                    });
                    
                    // Pilih tahun terbaru secara default
                    if (availableYears.length > 0) {
                        const mostRecentYear = availableYears[availableYears.length - 1];
                        selector.value = mostRecentYear;
                        currentYear = mostRecentYear;
                        
                        // Muat data untuk tahun terbaru
                        loadClusteringData(mostRecentYear);
                    }
                })
                .catch(error => {
                    console.error("Error fetching available years:", error);
                    // Fallback ke data default jika gagal
                    const years = ["2020", "2021", "2022", "2023", "2024"];
                    const selector = document.getElementById('year-selector');
                    
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        selector.appendChild(option);
                    });
                    
                    selector.value = "2024";
                    currentYear = "2024";
                    loadClusteringData("2024");
                });
        }

        // Fungsi untuk mengambil data clustering dan memperbarui peta
        function loadClusteringData(year) {
            const endpoint = year ? `/api/clustering-data?year=${year}` : '/api/clustering-data';
            
            // Hapus overlay petunjuk setelah data dimuat
            setTimeout(function() {
                var overlays = document.getElementsByClassName('map-overlay');
                if (overlays.length > 0) {
                    overlays[0].style.opacity = '0';
                    setTimeout(function() {
                        overlays[0].style.display = 'none';
                    }, 1000);
                }
            }, 5000);
            
            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (Object.keys(data).length > 0) {
                        console.log(`Clustering data loaded successfully for year ${year}`);
                        stuntingData = data; // Perbarui data stunting dengan hasil clustering
                        currentYear = year;
                        
                        // Perbarui warna pada peta
                        if (geojsonLayer) {
                            geojsonLayer.setStyle(function(feature) {
                                return {
                                    fillColor: getColor(feature),
                                    weight: 1,
                                    opacity: 1,
                                    color: 'white',
                                    dashArray: '3',
                                    fillOpacity: 0.7
                                };
                            });
                        }
                        
                        // Perbarui judul peta untuk menunjukkan tahun
                        updateMapTitle(year);
                    } else {
                        console.log(`No clustering data available for year ${year}`);
                    }
                })
                .catch(error => {
                    console.error(`Error loading clustering data for year ${year}:`, error);
                });
        }
        
        // Fungsi untuk memperbarui judul peta
        function updateMapTitle(year) {
            // Cek jika title container sudah ada
            let titleContainer = document.getElementById('map-title-container');
            
            if (!titleContainer) {
                // Buat title container jika belum ada
                titleContainer = document.createElement('div');
                titleContainer.id = 'map-title-container';
                titleContainer.className = 'map-title-container';
                document.body.appendChild(titleContainer);
            }
            
        }

        // Listen for year selector changes
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const yearSelector = document.getElementById('year-selector');
                if (yearSelector) {
                    yearSelector.addEventListener('change', function() {
                        const selectedYear = this.value;
                        loadClusteringData(selectedYear);
                        
                        // If a region is currently selected, update its information for the new year
                        if (currentRegionProps) {
                            setTimeout(function() {
                                updateRegionInfo(currentRegionProps);
                                updateForecastForRegion(currentRegionProps);
                            }, 300); // Small delay to ensure clustering data is loaded
                        }
                    });
                }
            }, 200);
        });

        // Fungsi untuk menentukan kategori berdasarkan nilai stunting
        function getStuntingCategory(value) {
            if (value < 20) return 'low';
            if (value < 30) return 'medium';
            return 'high';
        }

        // Fungsi untuk mendapatkan warna berdasarkan kategori atau nilai stunting
        function getColor(feature) {
            var regionId = feature.properties.GID_3;
            var ccId = feature.properties.CC_4;
            var data = null;
            
            // Cek data berdasarkan CC_3 terlebih dahulu (prioritas)
            if (ccId && stuntingData[ccId]) {
                data = stuntingData[ccId];
            }
            // Jika tidak ada data berdasarkan CC_3, gunakan GID_3
            else if (regionId && stuntingData[regionId]) {
                data = stuntingData[regionId];
            }
            
            // Jika ada data untuk region ini (dari CC_3 atau GID_3)
            if (data) {
                if (data.kategori === 'high') return '#d73027';   // Merah untuk tinggi
                if (data.kategori === 'medium') return '#fc8d59'; // Oranye untuk sedang
                if (data.kategori === 'low') return '#91cf60';    // Hijau untuk rendah
                return defaultColor; // Default jika tidak ada kategori
            }
            
            // Default jika tidak ada data
            return defaultColor;  // Default color jika tidak ada data
        }

        // Panel informasi
        var info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        info.update = function (props) {
            this._div.innerHTML = '<h4>Informasi Kecamatan</h4>' + 
                (props ? 
                    '<b>Kecamatan: ' + props.NAME_3 + '</b><br />' + 
                    'Kabupaten: ' + props.NAME_2 + '<br />' +
                    'Provinsi: ' + props.NAME_1
                    : 'Arahkan kursor atau klik pada daerah');
        };
        info.addTo(map);

        // Fungsi untuk mengupdate info di forecast container
        function updateRegionInfo(props) {
            var gid = props.GID_3;
            var ccId = props.CC_4;
            var regionName = props.NAME_3;
            var data = null;
            var prevalenceValue = null;
            
            // Cek jika data prediksi tersedia untuk kecamatan ini
            if (forecastData && forecastData[regionName] && currentYear) {
                // Get the data for current selected year from forecast data
                const forecastYearIndex = forecastData[regionName].labels.indexOf(currentYear);
                if (forecastYearIndex !== -1 && forecastData[regionName].historical[forecastYearIndex] !== null) {
                    prevalenceValue = forecastData[regionName].historical[forecastYearIndex];
                }
            }
            
            // Cek data berdasarkan CC_3 terlebih dahulu (prioritas)
            if (ccId && stuntingData[ccId]) {
                data = stuntingData[ccId];
            }
            // Jika tidak ada data berdasarkan CC_3, gunakan GID_3
            else if (gid && stuntingData[gid]) {
                data = stuntingData[gid];
            }
            // Jika tidak ada data sama sekali
            else {
                data = {
                    nilai: 'Data belum tersedia', 
                    kategori: 'unknown', 
                    faktorUtama: ['Belum ada data']
                };
            }
            
            // Update title dengan nama kecamatan dan tahun yang dipilih
            document.getElementById('region-title').innerText = 'Kecamatan ' + props.NAME_3 + 
                (currentYear ? ' (' + currentYear + ')' : '');
            
            // Update nilai prevalensi dengan data dari LSTM forecasting jika tersedia untuk tahun yang dipilih
            var categoryClass = data.kategori || 'unknown';
            if (prevalenceValue !== null) {
                // Update nilai dengan data dari forecasting untuk tahun yang dipilih
                document.getElementById('current-prevalence').innerHTML = 
                    'Prevalensi Saat Ini: <span class="' + categoryClass + '">' + prevalenceValue.toFixed(2) + '%</span>';
            } else {
                // Fallback ke data clustering jika forecasting tidak tersedia
                document.getElementById('current-prevalence').innerHTML = 
                    'Prevalensi Saat Ini: <span class="' + categoryClass + '">' + data.nilai + '%</span>';
            }
            
            // Update faktor-faktor jika ada
            if (data.faktorUtama && data.faktorUtama.length > 0) {
                var factorsListElement = document.getElementById('factors-list');
                factorsListElement.innerHTML = '';
                
                data.faktorUtama.forEach(function(faktor) {
                    var li = document.createElement('li');
                    li.textContent = faktor;
                    factorsListElement.appendChild(li);
                });
                document.getElementById('factors-container').classList.remove('hidden');
            } else {
                document.getElementById('factors-container').classList.add('hidden');
            }
            
            // Pastikan forecast container terlihat
            document.getElementById('forecast-container').classList.remove('hidden');
            document.getElementById('toggle-forecast-btn').textContent = 'Sembunyikan';
        }

        // Fungsi highlight feature
        function highlightFeature(e) {
            var layer = e.target;
            var originalColor = getColor(layer.feature); // Dapatkan warna asli berdasarkan data
            
            layer.setStyle({
                weight: 3,
                color: '#666',
                dashArray: '',
                fillColor: originalColor, // Pertahankan warna fill asli
                fillOpacity: 0.8 // Sedikit lebih pekat untuk efek hover
            });
            
            layer.bringToFront();
            info.update(layer.feature.properties);
        }

        // Reset highlight
        function resetHighlight(e) {
            // Alih-alih memanggil resetStyle, tetapkan style secara manual
            e.target.setStyle({
                fillColor: getColor(e.target.feature), // Tetap gunakan warna dari data stunting
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            });
            
            info.update();
        }
        
        // Zoom ke feature dengan level konsisten
        function zoomToFeature(e) {
            var center = e.target.getBounds().getCenter();
            
            // Zoom level tetap untuk semua area (11 adalah level menengah)
            map.setView(center, 12);
            
            var props = e.target.feature.properties;
            info.update(props);
            
            currentRegionProps = props;
            
            // Update info di forecast container dan tampilkan forecast
            updateRegionInfo(props);
            updateForecastForRegion(props);
        }

        // Interaksi layer
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        // Load GeoJSON
        var geojsonLayer;
        fetch('madura.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJSON(data, {
                    style: function(feature) {
                        return {
                            fillColor: defaultColor,  // Mulai dengan warna default
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                // Load available years after map is loaded
                loadAvailableYears();
            });

        // Legenda untuk tingkat stunting
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML += '<h4>Status Stunting</h4>';
            
            // Definisi rentang nilai stunting dan warnanya
            var grades = [
                {min: 30, label: 'Tinggi', color: '#d73027'},
                {min: 20, max: 30, label: 'Sedang', color: '#fc8d59'},
                {min: 0, max: 20, label: 'Rendah', color: '#91cf60'},
                {label: 'Data tidak tersedia', color: defaultColor}
            ];
            
            // Buat item legenda untuk setiap rentang nilai
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + (grades[i].color || defaultColor) + '"></i> ' +
                    grades[i].label + '<br>';
            }
            
            return div;
        };
        legend.addTo(map);

        // LSTM Forecasting Chart functionality
        let forecastChart = null;
        let forecastData = {};
        
        // Function to toggle forecast container visibility
        function toggleForecastContainer() {
            const container = document.getElementById('forecast-container');
            const btn = document.getElementById('toggle-forecast-btn');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                btn.textContent = 'Sembunyikan';
            } else {
                container.classList.add('hidden');
                btn.textContent = 'Tampilkan';
            }
        }
        
        // Function to show "no data" message when forecast data isn't available
        function showNoForecastData(regionName) {
            const container = document.getElementById('forecast-container');
            
            // Update title to show the region name and year
            document.getElementById('region-title').innerText = regionName ? 
                'Kecamatan ' + regionName + (currentYear ? ' (' + currentYear + ')' : '') : 
                'Tren Prevalensi Stunting';
            
            // Clear prevalence info
            document.getElementById('current-prevalence').innerHTML = '';
            
            // Hide factors container
            document.getElementById('factors-container').classList.add('hidden');
            
            // Destroy existing chart if it exists
            if (forecastChart) {
                forecastChart.destroy();
                forecastChart = null;
            }
            
            // Get chart container and display "no data" message
            const chartContainer = document.querySelector('.chart-container');
            chartContainer.innerHTML = '<canvas id="forecast-chart"></canvas><div class="no-data-message">Data prediksi belum tersedia untuk wilayah ini</div>';
            
            // Make container visible
            container.classList.remove('hidden');
            document.getElementById('toggle-forecast-btn').textContent = 'Sembunyikan';
        }
        
        // Function to load forecasting data
        function loadForecastData() {
            fetch('/api/forecasting-data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error("Error loading forecast data:", data.error);
                        forecastData = {};
                        return;
                    }
                    
                    // Store data for later use with different regions
                    forecastData = data;
                    
                    // Reset title to default for all regions view
                    document.getElementById('region-title').innerText = 'Tren Prevalensi Stunting';
                    document.getElementById('current-prevalence').innerHTML = '';
                    document.getElementById('factors-container').classList.add('hidden');
                    
                    // Update chart with all regions data initially if it exists
                    if (data.all_regions && !document.getElementById('forecast-container').classList.contains('hidden')) {
                        updateForecastChart(data.all_regions);
                    }
                    
                    // Populate region selector
                    populateRegionSelector(Object.keys(data));
                })
                .catch(error => {
                    console.error("Error fetching forecast data:", error);
                    forecastData = {};
                });
        }
        
        // Function to update the forecast chart with new data
        function updateForecastChart(data) {
            const ctx = document.getElementById('forecast-chart').getContext('2d');
            
            // Check if data is empty or invalid
            if (!data || !data.labels || !data.historical || !data.forecast) {
                showNoForecastData();
                return;
            }
            
            // Clear any no-data message
            const chartContainer = document.querySelector('.chart-container');
            const noDataMessage = chartContainer.querySelector('.no-data-message');
            if (noDataMessage) {
                noDataMessage.remove();
            }
            
            // Destroy existing chart if it exists
            if (forecastChart) {
                forecastChart.destroy();
            }
            
            // Create new chart
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Data Historis',
                            data: data.historical,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2
                        },
                        {
                            label: 'Prediksi',
                            data: data.forecast,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderDash: [5, 5],
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Prevalensi Stunting (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tahun'
                            }
                        }
                    }
                }
            });
        }
        
        // Function to populate region selector dropdown
        function populateRegionSelector(regions) {
            const selector = document.getElementById('forecast-region-selector');
            
            // Clear existing options except the first one
            while (selector.options.length > 1) {
                selector.remove(1);
            }
            
            // Add options for each kecamatan (skip the 'all_regions' entry)
            regions
                .filter(r => r !== 'all_regions')
                .sort()
                .forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    selector.appendChild(option);
                });
        }
        
        // Listen for region selector changes
        document.getElementById('forecast-region-selector').addEventListener('change', function() {
            const selectedRegion = this.value;
            
            if (selectedRegion === 'all_regions') {
                // Reset current region when showing all regions
                currentRegionProps = null;
                document.getElementById('region-title').innerText = 'Tren Prevalensi Stunting';
                document.getElementById('current-prevalence').innerHTML = '';
                document.getElementById('factors-container').classList.add('hidden');
                
                if (forecastData.all_regions) {
                    updateForecastChart(forecastData.all_regions);
                } else {
                    showNoForecastData('Semua Wilayah');
                }
            }
            else if (selectedRegion && forecastData[selectedRegion]) {
                // Find matching region in map data if possible
                let regionProps = null;
                if (geojsonLayer) {
                    geojsonLayer.eachLayer(function(layer) {
                        if (layer.feature.properties.NAME_3 === selectedRegion) {
                            regionProps = layer.feature.properties;
                        }
                    });
                }
                
                // Update region info if we found a match
                if (regionProps) {
                    // Store current region
                    currentRegionProps = regionProps;
                    updateRegionInfo(regionProps);
                } else {
                    // Basic title update if no matching props found
                    currentRegionProps = null;
                    document.getElementById('region-title').innerText = 'Kecamatan ' + selectedRegion + 
                        (currentYear ? ' (' + currentYear + ')' : '');
                    document.getElementById('factors-container').classList.add('hidden');
                }
                
                // Update chart
                updateForecastChart(forecastData[selectedRegion]);
            } else {
                // No data for this region
                currentRegionProps = null;
                showNoForecastData(selectedRegion);
            }
        });
        
        // When map feature is clicked, update forecast chart if possible
        function updateForecastForRegion(props) {
            // Try to find a matching kecamatan name
            if (props && props.NAME_3) {
                const regionName = props.NAME_3;
                
                // Check if we have forecast data for this region
                if (forecastData[regionName]) {
                    // Update the selector
                    const selector = document.getElementById('forecast-region-selector');
                    selector.value = regionName;
                    
                    // Update the chart
                    updateForecastChart(forecastData[regionName]);
                } else {
                    // Show no data message
                    showNoForecastData(regionName);
                }
            }
        }
        
        // Load the forecast data when the page loads, but keep container hidden
        document.addEventListener('DOMContentLoaded', function() {
            // Load forecast data after a delay to ensure map is loaded
            setTimeout(function() {
                loadForecastData();
                // Make sure container remains hidden initially
                document.getElementById('forecast-container').classList.add('hidden');
                document.getElementById('toggle-forecast-btn').textContent = 'Tampilkan';
            });
        });
    </script>
</body>
</html>